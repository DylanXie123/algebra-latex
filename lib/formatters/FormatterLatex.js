"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _greekLetters = _interopRequireDefault(require("../models/greek-letters"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class LatexFormatter {
  constructor(ast) {
    _defineProperty(this, "ast", void 0);

    this.ast = ast;
  }

  format(root = this.ast) {
    if (root === null) {
      return '';
    }

    switch (root.type) {
      case 'operator':
        return this.operator(root);

      case 'number':
        return this.number(root);

      case 'function':
        return this.function(root);

      case 'variable':
        return this.variable(root);

      case 'equation':
        return this.equation(root);

      case 'subscript':
        return this.subscript(root);

      case 'uni-operator':
        return this.uni_operator(root);

      default:
        throw Error('Unexpected type: ' + root);
    }
  }

  operator(root) {
    let op = root.operator;

    switch (op) {
      case 'plus':
        op = '+';
        break;

      case 'minus':
        op = '-';
        break;

      case 'multiply':
        op = '\\cdot ';
        break;

      case 'divide':
        return this.fragment(root);

      case 'modulus':
        op = '%';
        break;

      case 'exponent':
        op = '^';
        break;

      default:
    }

    let lhs = this.format(root.lhs);
    let rhs = this.format(root.rhs);
    const precedensOrder = [['modulus'], ['exponent'], ['multiply'], ['plus', 'minus']];

    const higherPrecedens = (a, b) => {
      const depth = op => precedensOrder.findIndex(val => val.includes(op));

      return depth(b) > depth(a);
    };

    const shouldHaveParenthesis = child => child.type === 'operator' && higherPrecedens(root.operator, child.operator);

    let lhsParen = shouldHaveParenthesis(root.lhs);
    let rhsParen = shouldHaveParenthesis(root.rhs);
    lhs = lhsParen ? `\\left(${lhs}\\right)` : lhs;

    if (root.operator === 'exponent') {
      rhsParen = true;
      rhs = rhsParen ? `{${rhs}}` : rhs;
    } else {
      rhs = rhsParen ? `\\left(${rhs}\\right)` : rhs;
    }

    return `${lhs}${op}${rhs}`;
  }

  fragment(root) {
    let lhs = this.format(root.lhs);
    let rhs = this.format(root.rhs);
    return `\\frac{${lhs}}{${rhs}}`;
  }

  number(root) {
    return `${root.value}`;
  }

  function(root) {
    if (root.value === 'sqrt') {
      return `\\${root.value}{${this.format(root.content)}}`;
    }

    return `\\${root.value}\\left(${this.format(root.content)}\\right)`;
  }

  variable(root) {
    if (_greekLetters.default.map(l => l.name).includes(root.value.toLowerCase())) {
      return `\\${root.value}`;
    }

    return `${root.value}`;
  }

  equation(root) {
    return `${this.format(root.lhs)}=${this.format(root.rhs)}`;
  }

  subscript(root) {
    if (root.subscript.type === 'variable' && root.subscript.value.length === 1) {
      return `${this.format(root.base)}_${this.format(root.subscript)}`;
    }

    return `${this.format(root.base)}_{${this.format(root.subscript)}}`;
  }

  uni_operator(root) {
    if (root.operator === 'minus') {
      return `-${this.format(root.value)}`;
    }

    return this.format(root.value);
  }

}

exports.default = LatexFormatter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mb3JtYXR0ZXJzL0Zvcm1hdHRlckxhdGV4LnRzIl0sIm5hbWVzIjpbIkxhdGV4Rm9ybWF0dGVyIiwiY29uc3RydWN0b3IiLCJhc3QiLCJmb3JtYXQiLCJyb290IiwidHlwZSIsIm9wZXJhdG9yIiwibnVtYmVyIiwiZnVuY3Rpb24iLCJ2YXJpYWJsZSIsImVxdWF0aW9uIiwic3Vic2NyaXB0IiwidW5pX29wZXJhdG9yIiwiRXJyb3IiLCJvcCIsImZyYWdtZW50IiwibGhzIiwicmhzIiwicHJlY2VkZW5zT3JkZXIiLCJoaWdoZXJQcmVjZWRlbnMiLCJhIiwiYiIsImRlcHRoIiwiZmluZEluZGV4IiwidmFsIiwiaW5jbHVkZXMiLCJzaG91bGRIYXZlUGFyZW50aGVzaXMiLCJjaGlsZCIsImxoc1BhcmVuIiwicmhzUGFyZW4iLCJ2YWx1ZSIsImNvbnRlbnQiLCJncmVla0xldHRlcnMiLCJtYXAiLCJsIiwibmFtZSIsInRvTG93ZXJDYXNlIiwibGVuZ3RoIiwiYmFzZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOzs7Ozs7QUFHZSxNQUFNQSxjQUFOLENBQXFCO0FBR2xDQyxFQUFBQSxXQUFXLENBQUNDLEdBQUQsRUFBVztBQUFBOztBQUNwQixTQUFLQSxHQUFMLEdBQVdBLEdBQVg7QUFDRDs7QUFFREMsRUFBQUEsTUFBTSxDQUFDQyxJQUFJLEdBQUcsS0FBS0YsR0FBYixFQUEwQjtBQUM5QixRQUFJRSxJQUFJLEtBQUssSUFBYixFQUFtQjtBQUNqQixhQUFPLEVBQVA7QUFDRDs7QUFFRCxZQUFRQSxJQUFJLENBQUNDLElBQWI7QUFDRSxXQUFLLFVBQUw7QUFDRSxlQUFPLEtBQUtDLFFBQUwsQ0FBY0YsSUFBZCxDQUFQOztBQUNGLFdBQUssUUFBTDtBQUNFLGVBQU8sS0FBS0csTUFBTCxDQUFZSCxJQUFaLENBQVA7O0FBQ0YsV0FBSyxVQUFMO0FBQ0UsZUFBTyxLQUFLSSxRQUFMLENBQWNKLElBQWQsQ0FBUDs7QUFDRixXQUFLLFVBQUw7QUFD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ckMsUUFBSUEsSUFBSSxDQUFDTyxTQUFMLENBQWVOLElBQWYsS0FBd0IsVUFBeEIsSUFBdUNELElBQUksQ0FBQ08sU0FBTCxDQUFlbUIsS0FBaEIsQ0FBaUNPLE1BQWpDLEtBQTRDLENBQXRGLEVBQXlGO0FBQ3ZGLGFBQVEsR0FBRSxLQUFLbEMsTUFBTCxDQUFZQyxJQUFJLENBQUNrQyxJQUFqQixDQUF1QixJQUFHLEtBQUtuQyxNQUFMLENBQVlDLElBQUksQ0FBQ08sU0FBakIsQ0FBNEIsRUFBaEU7QUFDRDs7QUFFRCxXQUFRLEdBQUUsS0FBS1IsTUFBTCxDQUFZQyxJQUFJLENBQUNrQyxJQUFqQixDQUF1QixLQUFJLEtBQUtuQyxNQUFMLENBQVlDLElBQUksQ0FBQ08sU0FBakIsQ0FBNEIsR0FBakU7QUFDRDs7QUFFREMsRUFBQUEsWUFBWSxDQUFDUixJQUFELEVBQTRCO0FBQ3RDLFFBQUlBLElBQUksQ0FBQ0UsUUFBTCxLQUFrQixPQUF0QixFQUErQjtBQUM3QixhQUFRLElBQUcsS0FBS0gsTUFBTCxDQUFZQyxJQUFJLENBQUMwQixLQUFqQixDQUErQixFQUExQztBQUNEOztBQUVELFdBQU8sS0FBSzNCLE1BQUwsQ0FBWUMsSUFBSSxDQUFDMEIsS0FBakIsQ0FBUDtBQUNEOztBQXJJaUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZ3JlZWtMZXR0ZXJzIGZyb20gJy4uL21vZGVscy9ncmVlay1sZXR0ZXJzJ1xyXG5pbXBvcnQgQVNULCB7IEVxdWF0aW9uTm9kZSwgRnVuY3Rpb25Ob2RlLCBOdW1iZXJOb2RlLCBPcGVyYXRvck5vZGUsIFN1YnNjcmlwdE5vZGUsIFVuaU9wZXJOb2RlLCBWYXJpYWJsZU5vZGUgfSBmcm9tICcuL0FTVCdcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIExhdGV4Rm9ybWF0dGVyIHtcclxuICBhc3Q6IEFTVFxyXG5cclxuICBjb25zdHJ1Y3Rvcihhc3Q6IEFTVCkge1xyXG4gICAgdGhpcy5hc3QgPSBhc3RcclxuICB9XHJcblxyXG4gIGZvcm1hdChyb290ID0gdGhpcy5hc3QpOiBzdHJpbmcge1xyXG4gICAgaWYgKHJvb3QgPT09IG51bGwpIHtcclxuICAgICAgcmV0dXJuICcnXHJcbiAgICB9XHJcblxyXG4gICAgc3dpdGNoIChyb290LnR5cGUpIHtcclxuICAgICAgY2FzZSAnb3BlcmF0b3InOlxyXG4gICAgICAgIHJldHVybiB0aGlzLm9wZXJhdG9yKHJvb3QpXHJcbiAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubnVtYmVyKHJvb3QpXHJcbiAgICAgIGNhc2UgJ2Z1bmN0aW9uJzpcclxuICAgICAgICByZXR1cm4gdGhpcy5mdW5jdGlvbihyb290KVxyXG4gICAgICBjYXNlICd2YXJpYWJsZSc6XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudmFyaWFibGUocm9vdClcclxuICAgICAgY2FzZSAnZXF1YXRpb24nOlxyXG4gICAgICAgIHJldHVybiB0aGlzLmVxdWF0aW9uKHJvb3QpXHJcbiAgICAgIGNhc2UgJ3N1YnNjcmlwdCc6XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3Vic2NyaXB0KHJvb3QpXHJcbiAgICAgIGNhc2UgJ3VuaS1vcGVyYXRvcic6XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudW5pX29wZXJhdG9yKHJvb3QpXHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgdGhyb3cgRXJyb3IoJ1VuZXhwZWN0ZWQgdHlwZTogJyArIHJvb3QpXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBvcGVyYXRvcihyb290OiBPcGVyYXRvck5vZGUpOiBzdHJpbmcge1xyXG4gICAgbGV0IG9wOiBzdHJpbmcgPSByb290Lm9wZXJhdG9yXHJcblxyXG4gICAgc3dpdGNoIChvcCkge1xyXG4gICAgICBjYXNlICdwbHVzJzpcclxuICAgICAgICBvcCA9ICcrJ1xyXG4gICAgICAgIGJyZWFrXHJcbiAgICAgIGNhc2UgJ21pbnVzJzpcclxuICAgICAgICBvcCA9ICctJ1xyXG4gICAgICAgIGJyZWFrXHJcbiAgICAgIGNhc2UgJ211bHRpcGx5JzpcclxuICAgICAgICBvcCA9ICdcXFxcY2RvdCAnXHJcbiAgICAgICAgYnJlYWtcclxuICAgICAgY2FzZSAnZGl2aWRlJzpcclxuICAgICAgICByZXR1cm4gdGhpcy5mcmFnbWVudChyb290KVxyXG4gICAgICBjYXNlICdtb2R1bHVzJzpcclxuICAgICAgICBvcCA9ICclJ1xyXG4gICAgICAgIGJyZWFrXHJcbiAgICAgIGNhc2UgJ2V4cG9uZW50JzpcclxuICAgICAgICBvcCA9ICdeJ1xyXG4gICAgICAgIGJyZWFrXHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGxocyA9IHRoaXMuZm9ybWF0KHJvb3QubGhzKVxyXG4gICAgbGV0IHJocyA9IHRoaXMuZm9ybWF0KHJvb3QucmhzKVxyXG5cclxuICAgIGNvbnN0IHByZWNlZGVuc09yZGVyID0gW1xyXG4gICAgICBbJ21vZHVsdXMnXSxcclxuICAgICAgWydleHBvbmVudCddLFxyXG4gICAgICBbJ211bHRpcGx5J10sXHJcbiAgICAgIFsncGx1cycsICdtaW51cyddLFxyXG4gICAgXVxyXG5cclxuICAgIGNvbnN0IGhpZ2hlclByZWNlZGVucyA9IChhOiBzdHJpbmcsIGI6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBkZXB0aCA9IChvcDogc3RyaW5nKSA9PiBwcmVjZWRlbnNPcmRlci5maW5kSW5kZXgodmFsID0+IHZhbC5pbmNsdWRlcyhvcCkpXHJcblxyXG4gICAgICByZXR1cm4gZGVwdGgoYikgPiBkZXB0aChhKVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHNob3VsZEhhdmVQYXJlbnRoZXNpcyA9IChjaGlsZDogQVNUKSA9PlxyXG4gICAgICBjaGlsZC50eXBlID09PSAnb3BlcmF0b3InICYmIGhpZ2hlclByZWNlZGVucyhyb290Lm9wZXJhdG9yLCBjaGlsZC5vcGVyYXRvcilcclxuXHJcbiAgICBsZXQgbGhzUGFyZW4gPSBzaG91bGRIYXZlUGFyZW50aGVzaXMocm9vdC5saHMpXHJcbiAgICBsZXQgcmhzUGFyZW4gPSBzaG91bGRIYXZlUGFyZW50aGVzaXMocm9vdC5yaHMpXHJcblxyXG4gICAgbGhzID0gbGhzUGFyZW4gPyBgXFxcXGxlZnQoJHtsaHN9XFxcXHJpZ2h0KWAgOiBsaHNcclxuXHJcbiAgICBpZiAocm9vdC5vcGVyYXRvciA9PT0gJ2V4cG9uZW50Jykge1xyXG4gICAgICByaHNQYXJlbiA9IHRydWVcclxuICAgICAgcmhzID0gcmhzUGFyZW4gPyBgeyR7cmhzfX1gIDogcmhzXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByaHMgPSByaHNQYXJlbiA/IGBcXFxcbGVmdCgke3Joc31cXFxccmlnaHQpYCA6IHJoc1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBgJHtsaHN9JHtvcH0ke3Joc31gXHJcbiAgfVxyXG5cclxuICBmcmFnbWVudChyb290OiBPcGVyYXRvck5vZGUpOiBzdHJpbmcge1xyXG4gICAgbGV0IGxocyA9IHRoaXMuZm9ybWF0KHJvb3QubGhzKVxyXG4gICAgbGV0IHJocyA9IHRoaXMuZm9ybWF0KHJvb3QucmhzKVxyXG5cclxuICAgIHJldHVybiBgXFxcXGZyYWN7JHtsaHN9fXske3Joc319YFxyXG4gIH1cclxuXHJcbiAgbnVtYmVyKHJvb3Q6IE51bWJlck5vZGUpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIGAke3Jvb3QudmFsdWV9YFxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24ocm9vdDogRnVuY3Rpb25Ob2RlKTogc3RyaW5nIHtcclxuICAgIGlmIChyb290LnZhbHVlID09PSAnc3FydCcpIHtcclxuICAgICAgcmV0dXJuIGBcXFxcJHtyb290LnZhbHVlfXske3RoaXMuZm9ybWF0KHJvb3QuY29udGVudCl9fWBcclxuICAgIH1cclxuICAgIHJldHVybiBgXFxcXCR7cm9vdC52YWx1ZX1cXFxcbGVmdCgke3RoaXMuZm9ybWF0KHJvb3QuY29udGVudCl9XFxcXHJpZ2h0KWBcclxuICB9XHJcblxyXG4gIHZhcmlhYmxlKHJvb3Q6IFZhcmlhYmxlTm9kZSk6IHN0cmluZyB7XHJcbiAgICBpZiAoZ3JlZWtMZXR0ZXJzLm1hcChsID0+IGwubmFtZSkuaW5jbHVkZXMoKHJvb3QudmFsdWUgYXMgc3RyaW5nKS50b0xvd2VyQ2FzZSgpKSkge1xyXG4gICAgICByZXR1cm4gYFxcXFwke3Jvb3QudmFsdWV9YFxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGAke3Jvb3QudmFsdWV9YFxyXG4gIH1cclxuXHJcbiAgZXF1YXRpb24ocm9vdDogRXF1YXRpb25Ob2RlKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBgJHt0aGlzLmZvcm1hdChyb290Lmxocyl9PSR7dGhpcy5mb3JtYXQocm9vdC5yaHMpfWBcclxuICB9XHJcblxyXG4gIHN1YnNjcmlwdChyb290OiBTdWJzY3JpcHROb2RlKTogc3RyaW5nIHtcclxuICAgIGlmIChyb290LnN1YnNjcmlwdC50eXBlID09PSAndmFyaWFibGUnICYmIChyb290LnN1YnNjcmlwdC52YWx1ZSBhcyBzdHJpbmcpLmxlbmd0aCA9PT0gMSkge1xyXG4gICAgICByZXR1cm4gYCR7dGhpcy5mb3JtYXQocm9vdC5iYXNlKX1fJHt0aGlzLmZvcm1hdChyb290LnN1YnNjcmlwdCl9YFxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBgJHt0aGlzLmZvcm1hdChyb290LmJhc2UpfV97JHt0aGlzLmZvcm1hdChyb290LnN1YnNjcmlwdCl9fWBcclxuICB9XHJcblxyXG4gIHVuaV9vcGVyYXRvcihyb290OiBVbmlPcGVyTm9kZSk6IHN0cmluZyB7XHJcbiAgICBpZiAocm9vdC5vcGVyYXRvciA9PT0gJ21pbnVzJykge1xyXG4gICAgICByZXR1cm4gYC0ke3RoaXMuZm9ybWF0KHJvb3QudmFsdWUgYXMgQVNUKX1gXHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuZm9ybWF0KHJvb3QudmFsdWUgYXMgQVNUKVxyXG4gIH1cclxufVxyXG4iXX0=